generator client {
    provider = "prisma-client-js"
    output   = "./client-sqlite"
}

datasource db {
    provider = "sqlite"
    url      = "file:./pu_practice.db"
}

// ========== 1. 預處理數據相關資料表 ==========

enum OccupantType {
    OFFICE_WORKER
    STUDENT
    DEPOSITORY
}

/// 用於管理一組組預處理完成的分析數據集（黃金週數據）
model AnalysisDataset {
    id             String              @id @default(cuid())
    name           String              @unique
    description    String?
    building       String
    floor          String
    room           String
    startDate      DateTime            @map("start_date")
    endDate        DateTime            @map("end_date")
    occupantType   OccupantType        @map("occupant_type")
    meterIdL1      String              @map("meter_id_l1")
    meterIdL2      String              @map("meter_id_l2")
    totalRecords   Int                 @map("total_records")
    positiveLabels Int                 @map("positive_labels")
    createdAt      DateTime            @default(now()) @map("created_at")
    analysisData   AnalysisReadyData[]

    @@map("analysis_datasets")
}

/// 存放預處理完成、每分鐘的、可直接用於模型訓練的數據
model AnalysisReadyData {
    id                   String          @id @default(cuid())
    datasetId            String          @map("dataset_id")
    dataset              AnalysisDataset @relation(fields: [datasetId], references: [id])
    timestamp            DateTime
    room                 String
    rawWattageL1         Float           @map("raw_wattage_l1")
    rawWattageL2         Float           @map("raw_wattage_l2")
    wattage110v          Float           @map("wattage_110v")
    wattage220v          Float           @map("wattage_220v")
    wattageTotal         Float           @map("wattage_total")
    isPositiveLabel      Boolean         @default(false) @map("is_positive_label")
    sourceAnomalyEventId String?         @unique @map("source_anomaly_event_id")

    @@map("analysis_ready_data")
}

// ========== 2. 模型訓練與評估相關資料表 ==========

/// 記錄一次完整的模型訓練事件
model TrainedModel {
    id               String          @id @default(cuid())
    name             String
    scenarioType     String          @map("scenario_type") // "ERM_BASELINE" 或 "DOMAIN_ADAPTATION"
    status           String // "PENDING", "RUNNING", "COMPLETED", "FAILED"
    experimentRunId  String          @map("experiment_run_id")
    modelConfig      String          @map("model_config") // JSON as string for SQLite
    dataSourceConfig String          @map("data_source_config") // JSON as string for SQLite
    modelPath        String?         @map("model_path")
    trainingMetrics  String?         @map("training_metrics") // JSON as string for SQLite
    createdAt        DateTime        @default(now()) @map("created_at")
    completedAt      DateTime?       @map("completed_at")
    evaluationRuns   EvaluationRun[]

    @@map("trained_models")
}

/// 記錄一次獨立的模型評估事件
model EvaluationRun {
    id                String            @id @default(cuid())
    name              String
    scenarioType      String            @map("scenario_type") // "ERM_BASELINE", "GENERALIZATION_CHALLENGE", "DOMAIN_ADAPTATION"
    status            String // "PENDING", "RUNNING", "COMPLETED", "FAILED"
    trainedModelId    String            @map("trained_model_id")
    trainedModel      TrainedModel      @relation(fields: [trainedModelId], references: [id])
    testSetSource     String            @map("test_set_source") // JSON as string for SQLite
    evaluationMetrics String?           @map("evaluation_metrics") // JSON as string for SQLite
    createdAt         DateTime          @default(now()) @map("created_at")
    completedAt       DateTime?         @map("completed_at")
    predictions       ModelPrediction[]

    @@map("evaluation_runs")
}

/// 記錄單一樣本的預測結果
model ModelPrediction {
    id              String        @id @default(cuid())
    evaluationRunId String        @map("evaluation_run_id")
    evaluationRun   EvaluationRun @relation(fields: [evaluationRunId], references: [id])
    timestamp       DateTime
    predictionScore Float
    groundTruth     Int?

    @@map("model_predictions")
}
